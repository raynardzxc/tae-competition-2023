---
title: "Raynard EDA Notebook"
output: html_notebook
---

Discrete Choice Model

# Import Libraries
```{r}
rm(list=ls())
# Execute our custom script for loading packages
source("usePackages.R")
# Name of the packages 
pkgnames <- c("mlogit","dplyr","splitTools")
# Use our custom load function
loadPkgs(pkgnames)
```

# Import Data
```{r}
safety <- read.csv("../input/train1_preprocessed.csv")
str(safety)
head(safety)
```
There are a total of 21565 observations on 113 variables. Each customer performs 19 different choice tasks and there are a total of 1135 customers.

Case: Customer number (1 to 1135)
No: Observation number (1 to 21565)
Task: Task number for a customer (1 to 19)

Each customer has to make a choice among four packages in each task. For example customer 1 in the first choice task chooses Ch2. In this choice situations, the attributes were:
Alternative 1 (Ch1) - GN 1, NS 4, BU 6, FP 3, RP 1, PP 1, TS 1, NV 1, MA 4, Price 2
Alternative 2 (Ch2) - GN 2, NS 1, BU 2, FP 2, RP 1, PP 1, TS 1, NV 1, MA 1, Price 2
Alternative 3 (Ch3) - GN 2, NS 4, BU 5, FP 3, RP 2, PP 3, TS 3, NV 1, MA 1, Price 2
Alternative 4 (Ch4) - Outside option
The variables are as follows:

CC: Cruise control - 3 levels

GN: Go notifier - 2 levels

NS: Navigation system - 5 levels

BU: Backup aids - 6 levels

FA: Front park assist - 2 levels

LD  Lane departure - 3 levels

BZ: Blind zone alert - 3 levels

FC: Front collision warning - 2 levels

FP: Front collision protection - 4 levels

RP: Rear collision protection - 4 levels

PP: Parallel park aids - 3 levels

KA: Knee air bags - 2 levels

SC: Side air bags - 4 levels

TS: Emergency notification - 3 levels

NV: Night vision system - 3 levels

MA: Driver assisted adjustment - 4 levels

LB: Low speed breaking assist - 4 levels

AF: Adaptive Front lighting - 3 levels

HU: Head up display - 2 levels

Price: 11 levels of price (300, 1000, 1500, 2000, 2500, 3000, 4000, 5000, 7500, 10000, 12000)

The variables from "segment" to "ppark" give demographic information:

segment = segment of car population that individual has

year = year

miles = mileage

night = % of time customer drives at night

gender = gender(Female or Male)

age = age bracket

educ = Education level (college (4 years), Grade School, High School, Postgrad, college (1-3 yrs), vocational school)

region = resident of region (MW, NE, SE, SW, W)

Urb = resident of  Rural, Suburban, Urban

income = income

Ch1 = 1 if package 1 is chosen, 0 otherwise

Ch2 = 1 if package 2 is chosen, 0 otherwise

Ch3 = 1 if package 3 is chosen, 0 otherwise

Ch4 = 1 if package 4 is chosen, 0 otherwise

Choice = Ch1 or Ch2 or Ch3 or Ch4 (depending on which option is chosen)

## Getting column id's of start and end
```{r}
which(colnames(safety)=="CC1")
which(colnames(safety)=="Price4")
```

Columns 4 to 83 of the safety data frame contains the attribute levels for each of the 4 alternatives (choices) indexed by 1,2,3 and 4 respectively.

## Split train-test
```{r}
# Split data into partitions
set.seed(42)
inds <- partition(safety$Choice, p = c(train = 0.8, test = 0.2))
str(inds)
```

```{r}
train_set <- safety[inds$train, ]
test_set <- safety[inds$test, ]
table(train_set$Choice)
table(test_set$Choice)
```

```{r}
train<-dfidx(train_set, shape="wide", choice="Choice", varying =c(4:83), sep="",idx = list(c("No", "Case")))
```

```{r}
M1 <- mlogit(Choice~CC+GN+NS+BU+FA+LD+BZ+FC+FP+RP+PP+KA+SC+TS+NV+MA+LB+AF+HU+Price-1, data=train, rpar=c(CC='n', GN='n', NS='n', BU='n',FA='n',LD='n',BZ='n',FC='n',FP='n',RP='n',PP='n',KA='n',SC='n',TS='n',NV='n',MA='n',LB='n',AF='n',HU='n',Price='n'), panel = TRUE, print.level=TRUE)
```
Note that the four alternatives (choice observations) are not comparable, so we do not introduce alternate specific estimates.

```{r}
summary(M1)
```

```{r}
M1loglik<-round(as.numeric(M1$logLik),digits=2)
M1loglik
AICM1<- -2*M1loglik +2*40
AICM1
```

```{r}
P1 <- predict(M1, newdata=train)
PredictedChoice1 <- apply(P1, 1, which.max)
ActualChoice <- train_set[,"Choice"]
Tabtrainmixed <- table(PredictedChoice1, ActualChoice)
Tabtrainmixed
```
```{r}
Test <- dfidx(test_set, shape="wide", choice="Choice", varying = c(4:83), sep="",idx = list(c("No", "Case")))
TestPredict1 <- predict(M1, newdata=Test)
PredictedChoice1 <- apply(TestPredict1,1,which.max)
ActualChoice1 <- test_set[,"Choice"]
Tabtestmixed= table(PredictedChoice1, ActualChoice1)
Tabtestmixed
```
```{r}
testpredict_df <- as.data.frame(TestPredict1)
colnames(testpredict_df) <- c("Ch1", "Ch2", "Ch3", "Ch4")
```

# Calculate Loss
```{r}
loss <- -1/nrow(test_set) * sum(test_set$Ch1 * log(testpredict_df$Ch1) +
                                test_set$Ch2 * log(testpredict_df$Ch2) +
                                test_set$Ch3 * log(testpredict_df$Ch3) +
                                test_set$Ch4 * log(testpredict_df$Ch4))
loss
```

# Generate Predictions
```{r}
predict_data <- read.csv("../input/test1.csv")
predict_data$Choice <- 0
which(colnames(safety)=="CC1")
which(colnames(safety)=="Price4")
```
```{r}
predict <- dfidx(predict_data, shape="wide", choice="Choice", varying = c(4:83), sep="",idx = list(c("No", "Case")))
prediction <- predict(M1, newdata=predict)

# Converting the prediction matrix into a data frame
prediction_df <- as.data.frame(prediction)
# Renaming the columns as per your requirement
colnames(prediction_df) <- c("Ch1", "Ch2", "Ch3", "Ch4")
# Adding the 'No' column from original dataset to the prediction data frame
prediction_df$No <- predict_data$No
# Rearranging the columns
prediction_df <- prediction_df[c("No", "Ch1", "Ch2", "Ch3", "Ch4")]

# Writing the output to a csv file
write.csv(prediction_df, file = "../output/submission1.csv", row.names = FALSE)
```
