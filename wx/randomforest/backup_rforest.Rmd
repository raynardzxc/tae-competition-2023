---
title: "Random Forest"
output: html_notebook
---

## Import libraries
```{r}
rm(list=ls())
library(randomForest)
library(mltools)
library(data.table)
library(dfidx)
```

## Loading data
```{r}
totrain<- read.csv("train1.csv")
topredict <- read.csv("test1.csv")
```

## Perform pre-processing to both totrain and topredict data
```{r}
totrain$Choice <- ifelse(totrain$Ch1 == 1, 1,
                        ifelse(totrain$Ch2 == 1, 2,
                               ifelse(totrain$Ch3 == 1, 3,
                                      ifelse(totrain$Ch4 == 1, 4, NA))))
```

## Processing data to train model
```{r}
## The demographic columns are represented in different form (ie ind, a). We will use the a form if available as these give us more information than a one-hot or ind form. For the rest we will decide as such:

## criteria: factor if ind cannot be meaningfully compared with each other, else ind
## segment -> one-hot
## year -> ind
## ppark -> one-hot
## gender -> one-hot
## educ -> one-hot
## region -> one-hot
## Urb -> ind

#### note to self: doing all ind or a will lower the number of branches, maybe can try?

totrain$segment <- as.factor(totrain$segment)
totrain$ppark <- as.factor(totrain$ppark)
totrain$gender <- as.factor(totrain$gender)
totrain$educ <- as.factor(totrain$educ)
totrain$region <- as.factor(totrain$region)
totrain <- as.data.frame(one_hot(as.data.table(totrain)))

totrain <- subset(totrain, select = -c(segmentind,
                           year,
                           miles,
                           milesind,
                           night,
                           nightind,
                           pparkind,
                           genderind,
                           age,
                           ageind,
                           educind,
                           regionind,
                           Urb,
                           income,
                           incomeind,
                           Ch1,
                           Ch2,
                           Ch3,
                           Ch4))

## Split to train and test by Case -> so we are training and testing on the same person
train <- dfidx(subset(totrain, Task<=12), shape="wide", choice="Choice", sep="", varying = c(4:83), idx = c("No", "Case"))
test <- dfidx(subset(totrain, Task>12), shape="wide", choice="Choice", sep="", varying = c(4:83), idx = c("No", "Case"))

## Convert back to dataframe
train <- as.data.frame(train)
test <- as.data.frame(test)

## drop Task
train <- subset(train, select = -c(Task,idx))
test <- subset(test, select = -c(Task,idx))

train$Choice <- as.integer(train$Choice)
test$Choice <- as.integer(test$Choice)
# 
# ## split to x and y because idk why the formula one doesnt work
# train_x <- subset(train, select = -c(Choice))
# train_y <- subset(train, select = c(Choice))
# test_x <- subset(test, select = -c(Choice))
# test_y <- subset(test, select = c(Choice))
# 
# train_y$Choice <- as.factor(train_y$Choice)
# test_y$Choice <- as.factor(test_y$Choice)

```

## Preparing topredict for later
```{r}
topredict$segment <- as.factor(topredict$segment)
topredict$ppark <- as.factor(topredict$ppark)
topredict$gender <- as.factor(topredict$gender)
topredict$educ <- as.factor(topredict$educ)
topredict$region <- as.factor(topredict$region)
topredict <- as.data.frame(one_hot(as.data.table(topredict)))

topredict <- subset(topredict, select = -c(segmentind,
                           year,
                           miles,
                           milesind,
                           night,
                           nightind,
                           pparkind,
                           genderind,
                           age,
                           ageind,
                           educind,
                           regionind,
                           Urb,
                           income,
                           incomeind,
                           Ch1,
                           Ch2,
                           Ch3,
                           Ch4))

predict_set <- dfidx(subset(topredict, Task<=19), shape="wide", choice="Choice", sep="", varying = c(4:83), idx = c("No", "Case"))

predict_set <- as.data.frame(predict_set)
predict_set <- subset(predict_set, select = -c(Task,idx))
```



## Idk how to fix error when trying to do as.factor(Choice)~. so this is my work around
```{r}
# names <- colnames(train)
# # names
# # length(names)
# temp = ""
# for (i in 1:length(names)){
#   if (names[i]!="Choice"){
#     temp <- paste(temp, names[i], sep = "`+train$`")
#   }
# }
# temp
```



## Creating model
Using M = sqrt(p), we will use 4-5 number of features
```{r}
## planting my trees
set.seed(100)
#m1 <- randomForest(as.factor(train$Choice)~train$`segment_Full-size Pickup`+train$`segment_Midsize Car`)
#m1 <- randomForest(as.factor(train$Choice)~train$`segment_Full-size Pickup`+train$`segment_Midsize Car`+train$`segment_Midsize Luxury Utility segements`+train$`segment_Midsize Utility`+train$`segment_Prestige Luxury Sedan`+train$`segment_Small Car`+train$`yearind`+train$`milesa`+train$`nighta`+train$`ppark_Daily`+train$`ppark_Monthly`+train$`ppark_Never`+train$`ppark_Weekly`+train$`ppark_Yearly`+train$`gender_Female`+train$`gender_Male`+train$`agea`+train$`educ_College Graduate (4 Years)`+train$`educ_Grade School`+train$`educ_High School`+train$`educ_Postgraduate College`+train$`educ_Some College (1-3 Years)`+train$`educ_Trade/Vocational School`+train$`region_MW`+train$`region_NE`+train$`region_SE`+train$`region_SW`+train$`region_W`+train$`Urbind`+train$`incomea`+train$`CC`+train$`GN`+train$`NS`+train$`BU`+train$`FA`+train$`LD`+train$`BZ`+train$`FC`+train$`FP`+train$`RP`+train$`PP`+train$`KA`+train$`SC`+train$`TS`+train$`NV`+train$`MA`+train$`LB`+train$`AF`+train$`HU`+train$`Price`)

m2 <- randomForest(as.factor(Choice)~milesa+agea+incomea+Price+nighta+yearind, data = train)
# m1 <- randomForest(train_x,train_y,test_x,test_y)
#summary(m1)
#importance(m1)
```

## Testing model
```{r}
#predictforest <- predict(m1,newdata=test)
predictforest <- predict(m2,newdata=test)
acc <- table(test$Choice,predictforest)
acc <- sum(diag(acc))/sum(acc)
acc
## some cal for accuracy
```

## Checking area for improvement
```{r}
summary(m2)
importance(m2)
varImpPlot(m2)
```

## Getting final prediction
```{r}
prediction <- predict(m2,newdata=predict_set)
prediction_df <- as.data.frame(prediction)
colnames(prediction_df) <- c("Ch1", "Ch2", "Ch3", "Ch4")
```

